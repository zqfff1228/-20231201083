{% extends 'base.html' %}

{% block title %}发帖 - 百度贴吧{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet">
<style>
    .tag-input-container {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 0.375rem 0.75rem;
        min-height: 38px;
        background-color: white;
    }
    .tag-input-container .tag {
        display: inline-block;
        background-color: #e9ecef;
        border-radius: 0.25rem;
        padding: 0.125rem 0.5rem;
        margin: 0.125rem;
        font-size: 0.875rem;
    }
    .tag-input-container .tag .remove {
        margin-left: 0.25rem;
        cursor: pointer;
        color: #6c757d;
    }
    .tag-input-container .tag-input {
        border: none;
        outline: none;
        min-width: 100px;
        flex: 1;
    }
    .ql-editor {
        min-height: 200px;
    }
    .form-control:invalid {
        border-color: #dc3545;
    }
    .form-control:valid {
        border-color: #198754;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card">
            <div class="card-header">
                <h4>发布新帖子</h4>
            </div>
            <div class="card-body">
                <form method="post" id="post-form" novalidate>
                    {% csrf_token %}
                    
                    <!-- 标题输入框 -->
                    <div class="mb-3">
                        <label for="title" class="form-label">帖子标题 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="title" name="title" required maxlength="200" 
                               placeholder="请输入帖子标题（2-200个字符）" minlength="2">
                        <div class="invalid-feedback">请输入2-200个字符的标题</div>
                    </div>
                    
                    <!-- 分类选择下拉框 -->
                    <div class="mb-3">
                        <label for="category" class="form-label">选择分类 <span class="text-danger">*</span></label>
                        <select class="form-select" id="category" name="category" required>
                            <option value="">请选择分类</option>
                            {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback">请选择帖子分类</div>
                    </div>
                    
                    <!-- 标签输入组件 -->
                    <div class="mb-3">
                        <label for="tags" class="form-label">标签（可选）</label>
                        <div class="tag-input-container d-flex flex-wrap align-items-center" id="tag-container">
                            <input type="text" class="tag-input" id="tag-input" placeholder="输入标签后按回车添加" maxlength="20">
                        </div>
                        <input type="hidden" id="tags" name="tags">
                        <div class="form-text">最多可添加5个标签，每个标签不超过20个字符</div>
                    </div>
                    
                    <!-- 富文本内容编辑器 -->
                    <div class="mb-3">
                        <label for="content" class="form-label">帖子内容 <span class="text-danger">*</span></label>
                        <div id="editor"></div>
                        <textarea class="form-control d-none" id="content" name="content" rows="10" required 
                                  placeholder="请输入帖子内容" minlength="10"></textarea>
                        <div class="invalid-feedback">请输入至少10个字符的内容</div>
                    </div>
                    
                    <!-- 按钮区域 -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'tieba:index' %}" class="btn btn-secondary me-md-2">取消</a>
                        <button type="button" class="btn btn-outline-primary me-md-2" id="save-draft">保存草稿</button>
                        <button type="submit" class="btn btn-primary">发布帖子</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
<script>
// 富文本编辑器初始化
const quill = new Quill('#editor', {
    theme: 'snow',
    modules: {
        toolbar: [
            ['bold', 'italic', 'underline', 'strike'],
            ['blockquote', 'code-block'],
            [{ 'header': 1 }, { 'header': 2 }],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            [{ 'script': 'sub'}, { 'script': 'super' }],
            [{ 'indent': '-1'}, { 'indent': '+1' }],
            [{ 'direction': 'rtl' }],
            [{ 'size': ['small', false, 'large', 'huge'] }],
            [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
            [{ 'color': [] }, { 'background': [] }],
            [{ 'font': [] }],
            [{ 'align': [] }],
            ['clean']
        ]
    },
    placeholder: '请输入帖子内容...',
});

// 标签管理
let tags = [];
const tagInput = document.getElementById('tag-input');
const tagContainer = document.getElementById('tag-container');
const tagsHidden = document.getElementById('tags');

function updateTagsHidden() {
    tagsHidden.value = JSON.stringify(tags);
}

function addTag(tagText) {
    tagText = tagText.trim();
    if (tagText && tags.length < 5 && !tags.includes(tagText) && tagText.length <= 20) {
        tags.push(tagText);
        
        const tagElement = document.createElement('span');
        tagElement.className = 'tag';
        tagElement.innerHTML = `${tagText}<span class="remove" onclick="removeTag('${tagText}')">×</span>`;
        
        tagContainer.insertBefore(tagElement, tagInput);
        tagInput.value = '';
        updateTagsHidden();
    }
}

function removeTag(tagText) {
    tags = tags.filter(tag => tag !== tagText);
    updateTagsHidden();
    renderTags();
}

function renderTags() {
    const tagElements = tagContainer.querySelectorAll('.tag');
    tagElements.forEach(tag => tag.remove());
    
    tags.forEach(tag => {
        const tagElement = document.createElement('span');
        tagElement.className = 'tag';
        tagElement.innerHTML = `${tag}<span class="remove" onclick="removeTag('${tag}')">×</span>`;
        tagContainer.insertBefore(tagElement, tagInput);
    });
}

tagInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        addTag(this.value);
    }
});

// 表单验证和提交处理
const form = document.getElementById('post-form');
const titleInput = document.getElementById('title');
const categorySelect = document.getElementById('category');
const contentTextarea = document.getElementById('content');

// 实时同步富文本编辑器内容到textarea
quill.on('text-change', function() {
    contentTextarea.value = quill.root.innerHTML;
});

// 表单验证函数
function validateForm() {
    let isValid = true;
    
    // 验证标题
    if (titleInput.value.length < 2 || titleInput.value.length > 200) {
        titleInput.classList.add('is-invalid');
        isValid = false;
    } else {
        titleInput.classList.remove('is-invalid');
    }
    
    // 验证分类
    if (!categorySelect.value) {
        categorySelect.classList.add('is-invalid');
        isValid = false;
    } else {
        categorySelect.classList.remove('is-invalid');
    }
    
    // 验证内容
    const content = quill.getText().trim();
    if (content.length < 10) {
        contentTextarea.classList.add('is-invalid');
        isValid = false;
    } else {
        contentTextarea.classList.remove('is-invalid');
    }
    
    return isValid;
}

// 实时验证
[titleInput, categorySelect].forEach(input => {
    input.addEventListener('input', validateForm);
});

quill.on('text-change', validateForm);

// 表单提交处理
form.addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (validateForm()) {
        // 设置发布模式
        const draftInput = document.createElement('input');
        draftInput.type = 'hidden';
        draftInput.name = 'is_draft';
        draftInput.value = 'false';
        form.appendChild(draftInput);
        
        form.submit();
    }
});

// 草稿保存功能
document.getElementById('save-draft').addEventListener('click', function() {
    if (validateForm()) {
        // 设置草稿模式
        const draftInput = document.createElement('input');
        draftInput.type = 'hidden';
        draftInput.name = 'is_draft';
        draftInput.value = 'true';
        form.appendChild(draftInput);
        
        form.submit();
    }
});

// 页面加载时初始化
window.addEventListener('load', function() {
    validateForm();
});
</script>
{% endblock %}